<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Torneo de Fútbol Interclases</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f0;
            background-image: linear-gradient(45deg, rgba(0,0,0,0.02) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.02) 75%),
                              linear-gradient(-45deg, rgba(0,0,0,0.02) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.02) 75%);
            background-size: 30px 30px;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #16a34a; /* green-600 */
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #15803d; /* green-700 */
        }
        .btn-secondary {
            background-color: #334155; /* slate-700 */
        }
        .btn-secondary:hover {
            background-color: #1e293b; /* slate-800 */
        }
        .btn-danger {
            background-color: #dc2626;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.3);
        }
        .input-field:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .table-header {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .winner-banner {
            background: linear-gradient(45deg, #facc15, #fbbf24, #f59e0b);
            color: #422006;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            border: 4px solid #fde047;
        }
        #modal, #loading-screen {
            transition: opacity 0.3s ease;
        }
        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div id="loading-screen" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50 p-4">
        <div class="spinner"></div>
        <p class="text-gray-600 mt-4">Cargando configuración segura...</p>
    </div>

    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 p-4 hidden">
        <div class="w-full max-w-sm">
            <div class="card text-center">
                <h2 id="login-title" class="text-2xl font-bold mb-4">Acceso Protegido</h2>
                <p id="login-subtitle" class="text-gray-600 mb-6">Por favor, introduce la clave maestra para continuar.</p>
                <div class="relative mb-4">
                    <input type="password" id="password-input" class="input-field pr-10" placeholder="••••••••">
                    <button id="toggle-password-btn" onclick="app.togglePasswordVisibility()" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 .847 0 1.67 .111 2.457 .311M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2 2l20 20" />
                        </svg>
                    </button>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button id="login-btn" class="btn btn-primary w-full">Continuar</button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-800 flex items-center justify-center">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
                Organizador de Torneo Interclases
            </h1>
            <p class="text-lg text-gray-600 mt-2">Gestiona los equipos, partidos y clasificaciones de forma fácil y rápida.</p>
        </header>

        <div id="winner-section" class="hidden card winner-banner">
            <h2 class="text-3xl font-bold mb-2">¡TENEMOS UN CAMPEÓN!</h2>
            <p id="winner-name" class="text-5xl font-extrabold"></p>
            <button onclick="app.resetTournament()" class="btn btn-secondary mt-6">Iniciar Nuevo Torneo</button>
        </div>

        <div id="main-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div id="config-panel">
                        <div class="card">
                             <h2 class="text-2xl font-bold mb-4 flex items-center text-green-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                1. Registrar Equipos
                            </h2>
                            <div id="add-team-wrapper" class="flex gap-2">
                                <input type="text" id="team-name" class="input-field" placeholder="Nombre del curso (Ej: 11-A)">
                                <button id="add-team-btn" onclick="app.addTeam()" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                </button>
                            </div>
                            <div id="teams-list" class="mt-4 space-y-2"></div>
                            <button id="clear-teams-btn" onclick="app.clearTeams()" class="btn btn-danger w-full mt-4 hidden">
                                Limpiar Equipos
                            </button>
                        </div>

                        <div class="card">
                             <h2 class="text-2xl font-bold mb-4 flex items-center text-green-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                2. Generar Partidos
                            </h2>
                            <p class="text-gray-600 mb-4">Genera un calendario justo, asegurando descansos adecuados entre partidos.</p>
                            <button id="generate-schedule-btn" onclick="app.generateSchedule()" class="btn btn-secondary w-full" disabled>Generar Calendario</button>
                            <button id="reset-tournament-btn" onclick="app.resetTournament()" class="btn btn-danger w-full mt-4 hidden">
                                Reiniciar Torneo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div id="schedule-section" class="space-y-6 hidden"></div>
                    <div id="standings-and-scorers" class="space-y-6 hidden">
                        <div id="standings-section" class="card">
                             <h2 class="text-2xl font-bold mb-4 flex items-center text-green-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                                Tabla de Posiciones
                            </h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm text-left">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="p-2">Pos</th><th class="p-2">Equipo</th>
                                            <th class="p-2 text-center">PJ</th><th class="p-2 text-center">G</th><th class="p-2 text-center">E</th><th class="p-2 text-center">P</th><th class="p-2 text-center">GF</th><th class="p-2 text-center">GC</th><th class="p-2 text-center">DG</th><th class="p-2 text-center">Pts</th>
                                        </tr>
                                    </thead>
                                    <tbody id="standings-body"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="top-scorers-section" class="card">
                             <h2 class="text-2xl font-bold mb-4 flex items-center text-green-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-9.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222 4 2.222V20M12 14" /></svg>
                                Goleadores del Torneo
                            </h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm text-left">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="p-2">Pos</th><th class="p-2">Jugador</th><th class="p-2">Equipo</th><th class="p-2 text-center">Goles</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-scorers-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                     <div id="final-match-section" class="card hidden">
                        <h2 class="text-2xl font-bold mb-4 text-center text-yellow-500">🔥 ¡LA GRAN FINAL! 🔥</h2>
                         <div id="final-match-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <div id="modal-message"></div>
                <div id="modal-buttons" class="flex justify-center gap-4 mt-6"></div>
            </div>
        </div>

        <datalist id="player-names"></datalist>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const App = function() {
            this.teams = [];
            this.schedule = [];
            this.finalMatch = null;
            this.masterPassword = '';
            this.isAuthenticated = false;
            this.initialLoadComplete = false;
            
            this.db = null;
            this.auth = null;
            this.userId = null;
            this.appId = 'default-soccer-app-id';
            this.unsubscribe = null;

            this.showAlert = function(message) {
                const modal = document.getElementById('modal');
                document.getElementById('modal-message').innerHTML = `<p class="text-lg">${message}</p>`;
                document.getElementById('modal-buttons').innerHTML = `<button onclick="app.hideModal()" class="btn btn-primary">Entendido</button>`;
                modal.classList.remove('hidden');
            }

            this.showConfirm = function(message, onConfirm) {
                const modal = document.getElementById('modal');
                document.getElementById('modal-message').innerHTML = `<p class="text-lg">${message}</p>`;
                document.getElementById('modal-buttons').innerHTML = `
                    <button onclick="app.hideModal()" class="btn btn-secondary">Cancelar</button>
                    <button id="confirm-btn" class="btn btn-danger">Confirmar</button>`;
                modal.classList.remove('hidden');
                document.getElementById('confirm-btn').onclick = () => {
                    this.hideModal();
                    onConfirm();
                };
            }

            this.showPasswordConfirm = function(message, onConfirm) {
                const modal = document.getElementById('modal');
                const passwordInput = document.getElementById('password-input');
                document.getElementById('modal-message').innerHTML = `
                    <p class="text-lg mb-4">${message}</p>
                    <p class="text-sm text-gray-600 mb-4">Por seguridad, introduce tu clave para confirmar.</p>
                    <input type="password" id="modal-password-input" class="input-field" placeholder="••••••••">
                    <p id="modal-error" class="text-red-500 text-sm h-5 mt-1"></p>`;
                document.getElementById('modal-buttons').innerHTML = `
                    <button onclick="app.hideModal()" class="btn btn-secondary">Cancelar</button>
                    <button id="confirm-password-btn" class="btn btn-danger">Confirmar</button>`;
                modal.classList.remove('hidden');
                const confirmBtn = document.getElementById('confirm-password-btn');
                const modalPasswordInput = document.getElementById('modal-password-input');
                modalPasswordInput.focus();
                const confirmationAction = () => {
                    if (modalPasswordInput.value === this.masterPassword) {
                        this.hideModal(); onConfirm();
                    } else {
                        document.getElementById('modal-error').textContent = 'Clave incorrecta.';
                    }
                };
                confirmBtn.onclick = confirmationAction;
                modalPasswordInput.onkeyup = (e) => { if (e.key === 'Enter') confirmationAction(); };
            }

            this.hideModal = function() {
                document.getElementById('modal').classList.add('hidden');
            }
            
            this.init = async function() {
                try {
                    const response = await fetch('/api/get-config');
                    if (!response.ok) throw new Error('No se pudo obtener la configuración del servidor. Revisa que el archivo /api/get-config.js exista y las variables de entorno en Vercel estén configuradas.');
                    const firebaseConfig = await response.json();

                    const firebaseApp = initializeApp(firebaseConfig);
                    this.db = getFirestore(firebaseApp);
                    this.auth = getAuth(firebaseApp);
                    this.appId = firebaseConfig.appId;
                    this.masterPassword = firebaseConfig.masterPassword;

                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            this.userId = user.uid;
                            if (!this.initialLoadComplete) {
                                this.initialLoadComplete = true;
                                document.getElementById('loading-screen').classList.add('hidden');
                                document.getElementById('login-screen').classList.remove('hidden');
                                this.checkAuth();
                            }
                            this.setupFirestoreListener();
                        } else {
                           await signInAnonymously(this.auth);
                        }
                    });
                } catch (error) {
                    console.error("Error crítico de inicialización:", error);
                    document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 font-semibold p-4 text-center">Error al cargar la aplicación: ${error.message}</p>`;
                }
            }
            
            this.setupFirestoreListener = function() {
                if (this.unsubscribe) this.unsubscribe();
                const mainStateRef = doc(this.db, "tournaments", this.appId, "data", "mainState");
                this.unsubscribe = onSnapshot(mainStateRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const state = docSnap.data();
                        this.teams = state.teams || [];
                        this.schedule = state.schedule || [];
                        this.finalMatch = state.finalMatch || null;
                    } else {
                        this.teams = []; this.schedule = []; this.finalMatch = null;
                    }
                    if(this.isAuthenticated) this.renderAll();
                });
            }
            
            this.saveStateToFirestore = async function() {
                if (!this.userId) return;
                const mainStateRef = doc(this.db, "tournaments", this.appId, "data", "mainState");
                await setDoc(mainStateRef, {
                    teams: JSON.parse(JSON.stringify(this.teams)), 
                    schedule: JSON.parse(JSON.stringify(this.schedule)),
                    finalMatch: JSON.parse(JSON.stringify(this.finalMatch)),
                });
            }

            this.checkAuth = function() {
                const loginBtn = document.getElementById('login-btn');
                const passwordInput = document.getElementById('password-input');
                passwordInput.focus();
                loginBtn.onclick = () => this.verifyPassword();
                passwordInput.onkeyup = (e) => { if (e.key === 'Enter') this.verifyPassword(); };
            }

            this.verifyPassword = function() {
                const passwordInput = document.getElementById('password-input');
                if (passwordInput.value === this.masterPassword) {
                    this.isAuthenticated = true;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    this.renderAll();
                } else {
                    document.getElementById('login-error').textContent = 'Clave incorrecta.';
                }
            }
            
            this.togglePasswordVisibility = function() {
                const passwordInput = document.getElementById('password-input');
                const eyeIcon = document.getElementById('eye-icon');
                const eyeSlashIcon = document.getElementById('eye-slash-icon');

                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeSlashIcon.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeSlashIcon.classList.add('hidden');
                }
            }
            
            this.addTeam = function() {
                if (this.schedule.length > 0) return;
                const teamNameInput = document.getElementById('team-name');
                const name = teamNameInput.value.trim();
                if (name && !this.teams.some(team => team.name === name)) {
                    this.teams.push({ name, pj: 0, g: 0, e: 0, p: 0, gf: 0, gc: 0, dg: 0, pts: 0 });
                    teamNameInput.value = '';
                    this.saveStateToFirestore();
                }
            }
            
            this.removeTeam = function(index) {
                if (this.schedule.length > 0) return;
                this.teams.splice(index, 1);
                this.saveStateToFirestore();
            }
            
            this.clearTeams = function() {
                 this.showConfirm("¿Estás seguro de que deseas eliminar todos los equipos?", () => {
                    this.teams = [];
                    this.saveStateToFirestore();
                 });
            }
            
            // INICIO CAMBIO: Híbrido - Asegura 1ro vs 2do y luego Round-Robin
            this.generateSchedule = function() {
                if (this.teams.length < 2) {
                    this.showAlert("Necesitas al menos 2 equipos para generar un calendario.");
                    return;
                }

                let teams = [...this.teams.map(t => t.name)];
                const schedule = [];

                if (teams.length % 2 !== 0) {
                    teams.push("descanso");
                }

                const numTeams = teams.length;
                const numRounds = numTeams - 1;

                for (let round = 0; round < numRounds; round++) {
                    const roundMatches = [];
                    for (let i = 0; i < numTeams / 2; i++) {
                        const team1 = teams[i];
                        const team2 = teams[numTeams - 1 - i];

                        if (team1 !== "descanso" && team2 !== "descanso") {
                             const match = (round % 2 === 1) 
                                ? { team1: team1, team2: team2 } 
                                : { team1: team2, team2: team1 };
                            roundMatches.push({
                                ...match,
                                score1: null, score2: null, played: false, 
                                bestPlayer: '', scorers: []
                            });
                        }
                    }
                    schedule.push({ round: round + 1, matches: roundMatches });

                    const lastTeam = teams.pop();
                    teams.splice(1, 0, lastTeam);
                }

                // Ahora, forzamos que el partido 1ro vs 2do sea en la Jornada 1.
                const team1Name = this.teams[0].name;
                const team2Name = this.teams[1].name;
                let targetRoundIndex = -1;

                // Buscamos la jornada donde se enfrentan el equipo 1 y 2.
                for (let i = 0; i < schedule.length; i++) {
                    const foundMatch = schedule[i].matches.find(m =>
                        (m.team1 === team1Name && m.team2 === team2Name) ||
                        (m.team1 === team2Name && m.team2 === team1Name)
                    );
                    if (foundMatch) {
                        targetRoundIndex = i;
                        break;
                    }
                }

                // Si encontramos la jornada y no es la primera, la movemos al inicio.
                if (targetRoundIndex > 0) {
                    const targetRound = schedule.splice(targetRoundIndex, 1)[0];
                    schedule.unshift(targetRound);
                }

                // Finalmente, re-numeramos todas las jornadas para que queden en orden (1, 2, 3...).
                schedule.forEach((round, index) => {
                    round.round = index + 1;
                });

                this.schedule = schedule;
                this.saveStateToFirestore();
            }
            // FIN CAMBIO

            this.updateScore = function(roundIndex, matchIndex) {
                const match = this.schedule[roundIndex].matches[matchIndex];
                const id = `${roundIndex}-${matchIndex}`;

                const score1 = parseInt(document.getElementById(`score1-${id}`).value);
                const score2 = parseInt(document.getElementById(`score2-${id}`).value);
                const bestPlayer = document.getElementById(`best-player-${id}`).value.trim();

                if (!isNaN(score1) && !isNaN(score2) && score1 >= 0 && score2 >= 0) {
                    match.score1 = score1;
                    match.score2 = score2;
                    match.played = true;
                    match.bestPlayer = bestPlayer;
                    this.saveStateToFirestore();
                }
            }

            this.requestEditMatch = function(roundIndex, matchIndex) {
                this.showPasswordConfirm("Introduce la clave para editar el marcador.", () => {
                    const id = `${roundIndex}-${matchIndex}`;
                    document.getElementById(`score1-${id}`).readOnly = false;
                    document.getElementById(`score2-${id}`).readOnly = false;
                    document.getElementById(`best-player-${id}`).readOnly = false;
                    document.getElementById(`edit-btn-${id}`).classList.add('hidden');
                    document.getElementById(`save-btn-${id}`).classList.remove('hidden');
                });
            }
            
            this.addScorer = function(roundIndex, matchIndex) {
                const match = this.schedule[roundIndex].matches[matchIndex];
                const id = `${roundIndex}-${matchIndex}`;
                
                const playerName = document.getElementById(`scorer-name-${id}`).value.trim();
                const teamName = document.getElementById(`scorer-team-${id}`).value;

                if (playerName && teamName) {
                    if (!match.scorers) match.scorers = [];
                    match.scorers.push({ player: playerName, team: teamName });
                    document.getElementById(`scorer-name-${id}`).value = '';
                    this.saveStateToFirestore();
                }
            }

            this.removeScorer = function(roundIndex, matchIndex, scorerIndex) {
                const match = this.schedule[roundIndex].matches[matchIndex];
                if (match && match.scorers) {
                    match.scorers.splice(scorerIndex, 1);
                    this.saveStateToFirestore();
                }
            }

            this.calculateTeamStats = function() {
                this.teams.forEach(team => { 
                    team.pj=0; team.g=0; team.e=0; team.p=0; 
                    team.gf=0; team.gc=0; team.dg=0; team.pts=0; 
                });
                
                this.schedule.forEach(round => {
                    if (round && round.matches) {
                        round.matches.forEach(match => {
                            if (match.played) {
                                const t1 = this.teams.find(t => t.name === match.team1);
                                const t2 = this.teams.find(t => t.name === match.team2);
                                if (!t1 || !t2) return;
                                t1.pj++; t2.pj++;
                                t1.gf += match.score1; t1.gc += match.score2;
                                t2.gf += match.score2; t2.gc += match.score1;
                                if (match.score1 > match.score2) { t1.g++; t2.p++; t1.pts += 3; }
                                else if (match.score2 > match.score1) { t2.g++; t1.p++; t2.pts += 3; }
                                else { t1.e++; t2.e++; t1.pts += 1; t2.pts += 1; }
                            }
                        });
                    }
                });

                this.teams.forEach(t => t.dg = t.gf - t.gc);
                this.teams.sort((a, b) => b.pts - a.pts || b.dg - a.dg || b.gf - a.gf || a.name.localeCompare(b.name));
            }
            
            this.checkIfTournamentFinished = function() {
                 const allPlayed = this.schedule.length > 0 && this.schedule.every(r => r.matches.every(m => m.played));
                if(allPlayed && !this.finalMatch && this.teams.length >= 2) {
                   this.finalMatch = { 
                       team1: this.teams[0].name, team2: this.teams[1].name, 
                       score1: null, score2: null, played: false, winner: null, 
                       bestPlayer: '', scorers: [] 
                    };
                   this.saveStateToFirestore();
                }
            }
            
            this.updateFinalScore = function() { /* ... Lógica similar a updateScore pero para la final ... */ }
            
            this.resetTournament = function() {
                this.showConfirm("¿Estás seguro? Se borrarán todos los datos del torneo actual.", async () => {
                    const mainStateRef = doc(this.db, "tournaments", this.appId, "data", "mainState");
                    await deleteDoc(mainStateRef);
                });
            }

            this.calculateAndRenderTopScorers = function() {
                 const scorerMap = new Map();
                 this.schedule.forEach(round => {
                    if (round && round.matches) {
                        round.matches.forEach(match => {
                            if(match.scorers) {
                                match.scorers.forEach(scorer => {
                                    const key = `${scorer.player}-${scorer.team}`;
                                    if (!scorerMap.has(key)) scorerMap.set(key, { player: scorer.player, team: scorer.team, goals: 0 });
                                    scorerMap.get(key).goals++;
                                });
                            }
                        });
                    }
                 });
                const sortedScorers = Array.from(scorerMap.values()).sort((a, b) => b.goals - a.goals);
                document.getElementById('top-scorers-body').innerHTML = sortedScorers.map((s, i) => `<tr><td class="p-2 font-bold">${i+1}</td><td class="p-2">${s.player}</td><td class="p-2 text-gray-600">${s.team}</td><td class="p-2 text-center font-bold">${s.goals}</td></tr>`).join('');
            }

            this.renderAll = function() {
                if (!this.isAuthenticated) return;
                
                this.calculateTeamStats();
                
                const scheduleGenerated = this.schedule.length > 0;
                document.getElementById('add-team-wrapper').classList.toggle('opacity-50', scheduleGenerated);
                document.getElementById('team-name').disabled = scheduleGenerated;
                document.getElementById('add-team-btn').disabled = scheduleGenerated;
                document.getElementById('standings-and-scorers').classList.toggle('hidden', !scheduleGenerated);


                this.renderTeams();
                this.renderSchedule();
                this.renderStandings();
                this.calculateAndRenderTopScorers();
                
                this.checkIfTournamentFinished();
                
                if (this.finalMatch) {
                    if (this.finalMatch.winner) {
                        document.getElementById('winner-section').classList.remove('hidden');
                        document.getElementById('winner-name').textContent = `🎉 ${this.finalMatch.winner} 🎉`;
                        document.getElementById('main-content').classList.add('hidden');
                    } else {
                        this.renderFinalMatch();
                    }
                } else {
                     document.getElementById('final-match-section').classList.add('hidden');
                }
            }
            
            this.renderTeams = function() {
                document.getElementById('teams-list').innerHTML = this.teams.map((team, index) => `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                        <span class="font-semibold">${team.name}</span>
                        <button onclick="app.removeTeam(${index})" class="text-red-500 hover:text-red-700 text-sm font-bold ${this.schedule.length > 0 ? 'hidden' : ''}">X</button>
                    </div>`).join('');
                document.getElementById('clear-teams-btn').classList.toggle('hidden', this.teams.length === 0 || this.schedule.length > 0);
                const hasData = this.teams.length > 0 || this.schedule.length > 0;
                document.getElementById('reset-tournament-btn').classList.toggle('hidden', !hasData);
                document.getElementById('generate-schedule-btn').disabled = this.teams.length < 2 || this.schedule.length > 0;
            }
            
            this.renderSchedule = function() {
                const section = document.getElementById('schedule-section');
                section.classList.toggle('hidden', this.schedule.length === 0);
                if (this.schedule.length > 0) {
                     section.innerHTML = this.schedule.map((round, roundIndex) => `
                        <div class="card">
                            <h3 class="text-xl font-bold mb-4 text-center text-green-700">Jornada ${round.round}</h3>
                            <div class="space-y-6">
                                ${round.matches.map((match, matchIndex) => this.renderMatchCard(match, roundIndex, matchIndex)).join('')}
                            </div>
                        </div>
                    `).join('');
                }
            }

            this.renderMatchCard = function(match, roundIndex, matchIndex) {
                 const id = `${roundIndex}-${matchIndex}`;
                 const isPlayed = match.played;
                 const readonlyAttr = isPlayed ? 'readonly' : '';
                 
                 return `
                    <div class="border p-4 rounded-lg ${isPlayed ? 'bg-gray-50' : ''}">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <div class="sm:w-1/3 text-center sm:text-right font-semibold text-lg">${match.team1}</div>
                            <div class="flex items-center justify-center gap-2">
                                <input type="number" min="0" id="score1-${id}" class="input-field text-center w-16 text-xl font-bold" value="${match.score1 ?? ''}" ${readonlyAttr}>
                                <span class="font-bold text-gray-400">vs</span>
                                <input type="number" min="0" id="score2-${id}" class="input-field text-center w-16 text-xl font-bold" value="${match.score2 ?? ''}" ${readonlyAttr}>
                            </div>
                            <div class="sm:w-1/3 text-center sm:text-left font-semibold text-lg">${match.team2}</div>
                        </div>

                        <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2">
                            <label for="best-player-${id}" class="text-sm font-semibold whitespace-nowrap">🏅 Mejor Jugador:</label>
                            <input type="text" id="best-player-${id}" class="input-field" placeholder="Nombre" value="${match.bestPlayer || ''}" ${readonlyAttr}>
                            
                            <button id="save-btn-${id}" onclick="app.updateScore(${roundIndex}, ${matchIndex})" class="btn btn-primary p-2 ${isPlayed ? 'hidden' : ''}">Guardar</button>
                            <button id="edit-btn-${id}" onclick="app.requestEditMatch(${roundIndex}, ${matchIndex})" class="btn btn-secondary p-2 ${!isPlayed ? 'hidden' : ''}">Editar</button>
                        </div>
                         <hr class="my-4">
                        <div class="text-sm">
                            <h4 class="font-semibold mb-2 text-center">Goles del Partido</h4>
                            <div class="flex flex-col sm:flex-row gap-2 items-center mb-2">
                                <input type="text" id="scorer-name-${id}" class="input-field" placeholder="Nombre del goleador">
                                <select id="scorer-team-${id}" class="input-field">
                                    <option value="${match.team1}">${match.team1}</option>
                                    <option value="${match.team2}">${match.team2}</option>
                                </select>
                                <button onclick="app.addScorer(${roundIndex}, ${matchIndex})" class="btn btn-secondary p-2 whitespace-nowrap w-full sm:w-auto">Añadir Gol</button>
                            </div>
                            <ul class="space-y-1 text-xs">
                                ${ (match.scorers || []).map((scorer, s_index) => `
                                    <li class="flex justify-between items-center bg-gray-100 p-1 rounded">
                                        <span>⚽ ${scorer.player} (${scorer.team})</span>
                                        <button onclick="app.removeScorer(${roundIndex}, ${matchIndex}, ${s_index})" class="text-red-500 font-bold text-xs">X</button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            this.renderStandings = function() {
                const body = document.getElementById('standings-body');
                body.innerHTML = this.teams.map((team, index) => `
                    <tr class="${index < 2 ? 'bg-green-100' : ''}">
                        <td class="p-2 font-bold">${index + 1}</td><td class="p-2">${team.name}</td>
                        <td class="p-2 text-center">${team.pj}</td><td class="p-2 text-center">${team.g}</td><td class="p-2 text-center">${team.e}</td><td class="p-2 text-center">${team.p}</td>
                        <td class="p-2 text-center">${team.gf}</td><td class="p-2 text-center">${team.gc}</td><td class="p-2 text-center font-semibold">${team.dg}</td>
                        <td class="p-2 text-center font-bold text-green-600">${team.pts}</td>
                    </tr>`).join('');
            }
            
            this.renderFinalMatch = function() { /* ... Renderizado de la final ... */ }
        }
        
        const app = new App();
        document.addEventListener('DOMContentLoaded', () => app.init());
        window.app = app; 
    </script>
</body>
</html>

